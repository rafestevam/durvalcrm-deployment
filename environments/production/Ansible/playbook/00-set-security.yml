---
- name: Set Security and Create Let's Encrypt Certificate
  hosts: vm-production
  become: yes
  vars:
    domain_name: "durvalcrm.org"
    cert_email: "admin@{{ domain_name }}"
    wildfly_home: "/opt/wildfly"
    wildfly_user: "wildfly"
    wildfly_group: "wildfly"
    letsencrypt_dir: "/etc/letsencrypt"
    certificates_dir: "/home/{{ ansible_user }}/certificates"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages for Let's Encrypt
      ansible.builtin.apt:
        name:
          - snapd
          - openssl
          - ca-certificates
          - python3-cryptography
          - default-jdk
        state: present

    - name: Create certificate directory in ansible_user home
      ansible.builtin.file:
        path: "{{ certificates_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Install certbot via snap
      community.general.snap:
        name: certbot
        classic: yes
        state: present

    - name: Create symbolic link for certbot
      ansible.builtin.file:
        src: /snap/bin/certbot
        dest: /usr/bin/certbot
        state: link

    - name: Stop services that might use port 80
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - apache2
        - nginx
        - wildfly
      ignore_errors: yes

    - name: Obtain Let's Encrypt certificate using standalone mode
      ansible.builtin.shell: |
        certbot certonly --standalone \
          --non-interactive \
          --agree-tos \
          --email {{ cert_email }} \
          --domains {{ domain_name }} \
          --force-renewal
      register: certbot_result
      failed_when: certbot_result.rc != 0

    - name: Copy Let's Encrypt certificate to certificates directory
      ansible.builtin.copy:
        src: "{{ letsencrypt_dir }}/live/{{ domain_name }}/fullchain.pem"
        dest: "{{ certificates_dir }}/server.crt"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
        remote_src: yes

    - name: Copy Let's Encrypt private key to certificates directory
      ansible.builtin.copy:
        src: "{{ letsencrypt_dir }}/live/{{ domain_name }}/privkey.pem"
        dest: "{{ certificates_dir }}/server.key"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
        remote_src: yes

    - name: Generate PEM bundle (certificate + key)
      ansible.builtin.shell: |
        cat {{ certificates_dir }}/server.crt \
            {{ certificates_dir }}/server.key \
            > {{ certificates_dir }}/server.pem
      args:
        creates: "{{ certificates_dir }}/server.pem"

    - name: Set proper permissions for PEM bundle
      ansible.builtin.file:
        path: "{{ certificates_dir }}/server.pem"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: Generate DH parameters for enhanced security (this may take a while)
      community.crypto.openssl_dhparam:
        path: "{{ certificates_dir }}/dhparam.pem"
        size: 2048
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'

    - name: Setup automatic certificate renewal
      ansible.builtin.cron:
        name: "Renew Let's Encrypt certificates"
        minute: "0"
        hour: "2"
        job: "/usr/bin/certbot renew --quiet --post-hook 'systemctl reload nginx && systemctl restart wildfly'"
        user: root

    - name: Create PKCS12 keystore for Java applications
      community.crypto.openssl_pkcs12:
        action: export
        path: "{{ certificates_dir }}/keystore.p12"
        certificate_path: "{{ certificates_dir }}/server.crt"
        privatekey_path: "{{ certificates_dir }}/server.key"
        passphrase: "changeit"
        friendly_name: "durvalcrm-cert"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    # ========== NOVAS TASKS PARA WILDFLY ==========

    - name: Check if WildFly directory exists
      ansible.builtin.stat:
        path: "{{ wildfly_home }}"
      register: wildfly_dir_check

    - name: Create WildFly configuration directory if needed
      ansible.builtin.file:
        path: "{{ wildfly_home }}/standalone/configuration"
        state: directory
        owner: "{{ wildfly_user }}"
        group: "{{ wildfly_group }}"
        mode: '0755'
        recurse: yes
      when: wildfly_dir_check.stat.exists

    - name: Check if source PKCS12 keystore exists
      ansible.builtin.stat:
        path: "{{ certificates_dir }}/keystore.p12"
      register: pkcs12_keystore_check

    - name: List contents of PKCS12 keystore
      ansible.builtin.shell: |
        keytool -list -keystore {{ certificates_dir }}/keystore.p12 \
                -storepass changeit -storetype PKCS12 -v | grep -A 5 "Alias name"
      register: pkcs12_contents
      when: pkcs12_keystore_check.stat.exists
      failed_when: false
      changed_when: false

    - name: Display PKCS12 keystore contents
      ansible.builtin.debug:
        msg: 
          - "PKCS12 keystore exists: {{ pkcs12_keystore_check.stat.exists }}"
          - "Contents: {{ pkcs12_contents.stdout if pkcs12_contents is defined else 'Could not read' }}"
      when: pkcs12_keystore_check.stat.exists

    - name: Create JKS keystore for WildFly management realm
      ansible.builtin.shell: |
        keytool -importkeystore \
          -srckeystore {{ certificates_dir }}/keystore.p12 \
          -srcstoretype PKCS12 \
          -srcstorepass changeit \
          -destkeystore {{ wildfly_home }}/certificates/management-production.keystore \
          -deststoretype JKS \
          -deststorepass production123 \
          -destkeypass production123 \
          -srcalias durvalcrm-cert \
          -destalias production-management \
          -noprompt 2>&1
      when: wildfly_dir_check.stat.exists and pkcs12_keystore_check.stat.exists
      register: management_keystore_result
      failed_when: false

    - name: Display management keystore creation result
      ansible.builtin.debug:
        msg:
          - "Management keystore creation return code: {{ management_keystore_result.rc | default('not executed') }}"
          - "Output: {{ management_keystore_result.stdout | default('') }}"
          - "Error: {{ management_keystore_result.stderr | default('') }}"
      when: management_keystore_result is defined

    - name: Create JKS keystore for WildFly application realm
      ansible.builtin.shell: |
        keytool -importkeystore \
          -srckeystore {{ certificates_dir }}/keystore.p12 \
          -srcstoretype PKCS12 \
          -srcstorepass changeit \
          -destkeystore {{ wildfly_home }}/certificates/application-production.keystore \
          -deststoretype JKS \
          -deststorepass production123 \
          -destkeypass production123 \
          -srcalias durvalcrm-cert \
          -destalias production-app \
          -noprompt 2>&1
      when: wildfly_dir_check.stat.exists and pkcs12_keystore_check.stat.exists
      register: application_keystore_result
      failed_when: false

    - name: Display application keystore creation result
      ansible.builtin.debug:
        msg:
          - "Application keystore creation return code: {{ application_keystore_result.rc | default('not executed') }}"
          - "Output: {{ application_keystore_result.stdout | default('') }}"
          - "Error: {{ application_keystore_result.stderr | default('') }}"
      when: application_keystore_result is defined

    - name: Set proper ownership and permissions for management keystore
      ansible.builtin.file:
        path: "{{ wildfly_home }}/certificates/management-production.keystore"
        owner: "{{ wildfly_user }}"
        group: "{{ wildfly_group }}"
        mode: '0600'
      when: wildfly_dir_check.stat.exists and management_keystore_result.rc == 0

    - name: Set proper ownership and permissions for application keystore
      ansible.builtin.file:
        path: "{{ wildfly_home }}/certificates/application-production.keystore"
        owner: "{{ wildfly_user }}"
        group: "{{ wildfly_group }}"
        mode: '0600'
      when: wildfly_dir_check.stat.exists and application_keystore_result.rc == 0

    - name: Verify management keystore was created successfully
      ansible.builtin.shell: |
        keytool -list -keystore {{ wildfly_home }}/certificates/management-production.keystore \
                -storepass production123 -alias production-management
      register: management_keystore_verify
      when: wildfly_dir_check.stat.exists and management_keystore_result.rc == 0
      failed_when: false
      changed_when: false

    - name: Verify application keystore was created successfully
      ansible.builtin.shell: |
        keytool -list -keystore {{ wildfly_home }}/certificates/application-production.keystore \
                -storepass production123 -alias production-app
      register: application_keystore_verify
      when: wildfly_dir_check.stat.exists and application_keystore_result.rc == 0
      failed_when: false
      changed_when: false

    # ========== INFORMAÇÕES E VERIFICAÇÕES ==========

    - name: Generate certificate information file
      ansible.builtin.copy:
        content: |
          Let's Encrypt Certificate Information
          ====================================
          Generated: {{ ansible_date_time.iso8601 }}
          Domain: {{ domain_name }}
          Host: {{ ansible_hostname }}
          IP Address: {{ ansible_default_ipv4.address }}
          Certificate Authority: Let's Encrypt
          Validity: 90 days (automatically renewed)
          
          Files Generated:
          - server.key: Private key (from Let's Encrypt)
          - server.crt: Let's Encrypt certificate (fullchain)
          - server.pem: Combined certificate and key (for Nginx, HAProxy, etc.)
          - dhparam.pem: Diffie-Hellman parameters
          - keystore.p12: PKCS12 keystore for Java applications (password: changeit)
          
          WildFly Keystores (if WildFly is installed):
          - management-production.keystore: JKS keystore for WildFly management (password: production123, alias: production-management)
          - application-production.keystore: JKS keystore for WildFly application (password: production123, alias: production-app)
          
          Certificate Details:
          --------------------
          Domain: {{ domain_name }}
          Email: {{ cert_email }}
          Certificate files location: {{ letsencrypt_dir }}/live/{{ domain_name }}/
          
          Auto-renewal:
          - Configured via cron job to run daily at 2 AM
          - Will automatically restart services after renewal
          
          Usage Examples:
          ---------------
          Nginx:
            ssl_certificate {{ certificates_dir }}/server.crt;
            ssl_certificate_key {{ certificates_dir }}/server.key;
            ssl_dhparam {{ certificates_dir }}/dhparam.pem;
          
          Apache:
            SSLCertificateFile {{ certificates_dir }}/server.crt
            SSLCertificateKeyFile {{ certificates_dir }}/server.key
          
          Java/Keycloak/WildFly:
            Use keystore.p12 with password: changeit
            OR use WildFly-specific JKS keystores with password: production123
        dest: "{{ certificates_dir }}/README.txt"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'

    - name: Display certificate information
      ansible.builtin.debug:
        msg:
          - "Let's Encrypt certificate has been successfully created"
          - "Certificate location: {{ certificates_dir }}/"
          - "Certificate files:"
          - "  - server.crt: Let's Encrypt certificate file (fullchain)"
          - "  - server.key: Private key file"
          - "  - server.pem: Combined certificate and key"
          - "  - dhparam.pem: DH parameters"
          - "  - keystore.p12: Java keystore (password: changeit)"
          - "Certificate is valid for 90 days and will auto-renew"
          - "Certificate domain: {{ domain_name }}"

    - name: Display WildFly keystore information
      ansible.builtin.debug:
        msg:
          - "WildFly keystores created successfully:"
          - "  - Management keystore: {{ wildfly_home }}/certificates/management-production.keystore"
          - "  - Application keystore: {{ wildfly_home }}/certificates/application-production.keystore"
          - "  - Password: production123"
          - "  - Management alias: production-management"
          - "  - Application alias: production-app"
      when: wildfly_dir_check.stat.exists and management_keystore_result.rc == 0 and application_keystore_result.rc == 0

    - name: Display WildFly keystore warnings
      ansible.builtin.debug:
        msg:
          - "WARNING: Some WildFly keystores failed to create:"
          - "  - Management keystore result: {{ 'SUCCESS' if management_keystore_result.rc == 0 else 'FAILED' }}"
          - "  - Application keystore result: {{ 'SUCCESS' if application_keystore_result.rc == 0 else 'FAILED' }}"
          - "Check the logs above for detailed error messages"
      when: wildfly_dir_check.stat.exists and (management_keystore_result.rc != 0 or application_keystore_result.rc != 0)

    - name: Display WildFly not found message
      ansible.builtin.debug:
        msg:
          - "WildFly directory not found at {{ wildfly_home }}"
          - "WildFly keystores were not created"
          - "Run this playbook again after WildFly installation"
      when: not wildfly_dir_check.stat.exists

    - name: Verify certificate validity
      ansible.builtin.shell: |
        openssl x509 -in /home/{{ ansible_user }}/certificates/server.crt -noout -dates
      register: cert_dates
      changed_when: false

    - name: Show certificate validity dates
      ansible.builtin.debug:
        msg: "{{ cert_dates.stdout_lines }}"

    - name: Test certificate chain
      ansible.builtin.shell: |
        openssl verify -CAfile /home/{{ ansible_user }}/certificates/server.crt /home/{{ ansible_user }}/certificates/server.crt
      register: cert_verify
      changed_when: false
      failed_when: false

    - name: Show certificate verification result
      ansible.builtin.debug:
        msg: "Certificate verification: {{ cert_verify.stdout }}"

    - name: Show keystore verification results
      ansible.builtin.debug:
        msg:
          - "Management keystore verification:"
          - "{{ management_keystore_verify.stdout if (management_keystore_verify is defined and management_keystore_verify.rc is defined and management_keystore_verify.rc == 0) else 'Verification failed or skipped' }}"
          - ""
          - "Application keystore verification:"
          - "{{ application_keystore_verify.stdout if (application_keystore_verify is defined and application_keystore_verify.rc is defined and application_keystore_verify.rc == 0) else 'Verification failed or skipped' }}"
      when: wildfly_dir_check.stat.exists